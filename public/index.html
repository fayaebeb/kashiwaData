<!doctype html>
<html lang="en">
  <head>
	    <meta charset="UTF-8" />
	    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
	    <meta http-equiv="Cache-Control" content="no-store" />
      <meta name="theme-color" content="#f7f3ff" />
	    <title>柏データダウンローダー</title>
    <style>
      :root {
        color-scheme: light;
        --bg0: #fff7fb;
        --bg1: #f3f0ff;
        --card: rgba(255, 255, 255, 0.75);
        --text: rgba(20, 18, 34, 0.92);
        --muted: rgba(20, 18, 34, 0.64);
        --border: rgba(69, 54, 118, 0.16);
        --shadow: 0 18px 60px rgba(23, 16, 46, 0.12);
        --primary0: #ff6fb1;
        --primary1: #7c6cff;
        --primary2: #22c7d1;
        --focus: rgba(124, 108, 255, 0.35);
      }
      @media (prefers-color-scheme: dark) {
        :root {
          color-scheme: dark;
          --bg0: #0b1220;
          --bg1: #101a2f;
          --card: rgba(255, 255, 255, 0.08);
          --text: rgba(255, 255, 255, 0.92);
          --muted: rgba(255, 255, 255, 0.68);
          --border: rgba(255, 255, 255, 0.16);
          --shadow: 0 18px 70px rgba(0, 0, 0, 0.45);
          --focus: rgba(124, 108, 255, 0.45);
        }
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 28px 16px;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          sans-serif;
        background:
          radial-gradient(1000px 650px at 10% 10%, rgba(255, 111, 177, 0.20), transparent 58%),
          radial-gradient(900px 620px at 90% 20%, rgba(124, 108, 255, 0.22), transparent 60%),
          radial-gradient(900px 700px at 40% 95%, rgba(34, 199, 209, 0.18), transparent 58%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        color: var(--text);
      }
      .bg {
        position: fixed;
        inset: 0;
        pointer-events: none;
        opacity: 0.9;
        filter: blur(0.2px);
      }
      .bg::before,
      .bg::after {
        content: "";
        position: absolute;
        width: 520px;
        height: 520px;
        border-radius: 40% 60% 55% 45% / 45% 45% 55% 55%;
        background: radial-gradient(circle at 30% 30%, rgba(255, 111, 177, 0.22), transparent 62%),
          radial-gradient(circle at 70% 70%, rgba(124, 108, 255, 0.18), transparent 60%);
        animation: floaty 9s ease-in-out infinite;
      }
      .bg::before {
        top: -140px;
        left: -180px;
      }
      .bg::after {
        bottom: -180px;
        right: -200px;
        animation-delay: -3.5s;
      }
      @keyframes floaty {
        0%,
        100% {
          transform: translate(0, 0) rotate(0deg);
        }
        50% {
          transform: translate(18px, -14px) rotate(4deg);
        }
      }
      .card {
        width: min(720px, calc(100% - 48px));
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 22px;
        padding: 26px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }
      h1 {
        font-size: 26px;
        margin: 0;
        letter-spacing: 0.1px;
        font-weight: 820;
      }
      .kicker {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0 0;
        color: var(--muted);
        line-height: 1.35;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.35);
      }
      .badge svg {
        width: 14px;
        height: 14px;
        opacity: 0.85;
      }
      @media (prefers-color-scheme: dark) {
        .badge {
          background: rgba(0, 0, 0, 0.18);
        }
      }
      p {
        margin: 14px 0 18px;
        color: var(--muted);
        line-height: 1.4;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      input {
        flex: 1 1 280px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.55);
        color: var(--text);
        outline: none;
      }
      @media (prefers-color-scheme: dark) {
        input {
          background: rgba(0, 0, 0, 0.18);
        }
      }
      input::placeholder {
        color: rgba(20, 18, 34, 0.45);
      }
      @media (prefers-color-scheme: dark) {
        input::placeholder {
          color: rgba(255, 255, 255, 0.45);
        }
      }
      input:focus-visible,
      button:focus-visible,
      a.button:focus-visible {
        outline: 3px solid var(--focus);
        outline-offset: 2px;
      }
      button,
      a.button {
        flex: 0 0 auto;
        padding: 11px 16px;
        border-radius: 14px;
        border: 1px solid rgba(69, 54, 118, 0.22);
        background: linear-gradient(135deg, rgba(255, 111, 177, 0.92), rgba(124, 108, 255, 0.92));
        color: rgba(255, 255, 255, 0.96);
        cursor: pointer;
        text-decoration: none;
        font-weight: 750;
        box-shadow: 0 12px 30px rgba(124, 108, 255, 0.24);
        transition:
          transform 140ms ease,
          box-shadow 140ms ease,
          filter 140ms ease;
      }
      @media (prefers-color-scheme: dark) {
        button,
        a.button {
          border-color: rgba(255, 255, 255, 0.22);
        }
      }
      button:hover,
      a.button:hover {
        transform: translateY(-1px);
        filter: brightness(1.03);
        box-shadow: 0 16px 40px rgba(124, 108, 255, 0.28);
      }
      button:active,
      a.button:active {
        transform: translateY(0px);
        box-shadow: 0 10px 26px rgba(124, 108, 255, 0.22);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .status {
        margin-top: 16px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px dashed var(--border);
        background: rgba(255, 255, 255, 0.45);
        color: var(--muted);
        font-size: 13px;
        min-height: 38px;
        display: grid;
        align-items: center;
      }
      @media (prefers-color-scheme: dark) {
        .status {
          background: rgba(0, 0, 0, 0.14);
        }
      }
      .footer {
        margin-top: 14px;
        font-size: 12px;
        color: var(--muted);
      }
      .footer a {
        color: inherit;
        text-decoration: none;
        border-bottom: 1px solid transparent;
      }
      .footer a:hover {
        border-bottom-color: var(--border);
      }
      code {
        font-family:
          ui-monospace,
          SFMono-Regular,
          Menlo,
          Monaco,
          Consolas,
          "Liberation Mono",
          "Courier New",
          monospace;
        color: rgba(255, 255, 255, 0.8);
      }
    </style>
  </head>
  <body>
    <div class="bg" aria-hidden="true"></div>
    <div class="card">
      <h1>柏データダウンローダー</h1>
      <div class="kicker">
        <span class="badge"
          ><svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M12 3v10m0 0 4-4m-4 4-4-4M5 17v2a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            /></svg
          >ZIP</span
        >
        <span>すべてのBlobをまとめてダウンロード</span>
      </div>
      <p>
        ボタンをクリックすると、設定されたAzure Blobコンテナー内のすべてのデータをZIPで取得できます。
      </p>
      <!-- <p>Optional:
        download only blobs that start with a prefix (folder path).</p> -->

      <div class="row">
        <!-- <input id="prefix" placeholder="Prefix (optional), e.g. reports/2025/" />
        <input id="token" placeholder="Access token (optional)" /> -->
        <button id="download">ZIPをダウンロード</button>
        <!-- <a class="button" id="health" href="/api/health" target="_blank" rel="noreferrer">Health</a> -->
      </div>

      <div class="status" id="status" aria-live="polite"></div>
      <div class="footer">
        ヒント: ダウンロードが始まるまで、このタブを閉じないでください。
      </div>
    </div>

    <script>
	      window.addEventListener("DOMContentLoaded", () => {
	        const prefixEl = document.getElementById("prefix");
	        const tokenEl = document.getElementById("token");
	        const statusEl = document.getElementById("status");
	        const downloadBtn = document.getElementById("download");
	        const healthLink = document.getElementById("health");

	        if (!statusEl || !downloadBtn) return;
	        statusEl.textContent = "準備OK。";

        const savedToken = window.localStorage.getItem("downloadAllToken");
        if (savedToken && tokenEl) tokenEl.value = savedToken;

        function getToken() {
          if (tokenEl) return tokenEl.value.trim();
          return (window.localStorage.getItem("downloadAllToken") || "").trim();
        }

	        function buildUrl(baseUrl) {
	          const prefix = prefixEl ? prefixEl.value.trim() : "";
	          const token = getToken();

          const params = new URLSearchParams();
          if (prefix) params.set("prefix", prefix);
          if (token) params.set("token", token);

          const query = params.toString();
          return query ? `${baseUrl}?${query}` : baseUrl;
        }

        function persistToken() {
          if (!tokenEl) return;
          const token = tokenEl.value.trim();
          if (token) window.localStorage.setItem("downloadAllToken", token);
          else window.localStorage.removeItem("downloadAllToken");
        }

        function refreshLinks() {
          if (healthLink) healthLink.href = buildUrl("/api/health");
        }

	        if (tokenEl) {
	          tokenEl.addEventListener("input", () => {
	            persistToken();
	            refreshLinks();
	          });
	        }
	        if (prefixEl) prefixEl.addEventListener("input", refreshLinks);
	        refreshLinks();

        downloadBtn.addEventListener("click", () => {
          persistToken();
          const url = buildUrl("/api/download-all");
          const healthUrl = buildUrl("/api/health");
          const listUrl = buildUrl("/api/list?limit=1");

          statusEl.textContent = "アクセス確認中…";

          fetch(healthUrl, { cache: "no-store" })
            .then(async (r) => {
              if (r.ok) return;
              const body = await r.text().catch(() => "");
              throw new Error(`${r.status} ${r.statusText}${body ? ` - ${body}` : ""}`);
            })
            .then(() =>
              fetch(listUrl, { cache: "no-store" }).then(async (r) => {
                if (r.ok) return;
                const body = await r.text().catch(() => "");
                throw new Error(`${r.status} ${r.statusText}${body ? ` - ${body}` : ""}`);
              })
            )
            .then(() => {
              statusEl.textContent =
                "ZIPを準備中… まもなくダウンロードが始まります。始まるまでこのタブを開いたままにしてください。";
              window.location.href = url;
            })
            .catch((err) => {
              statusEl.textContent = `ダウンロードできませんでした: ${String(err?.message || err)}`;
            });
        });
      });
    </script>
  </body>
</html>
